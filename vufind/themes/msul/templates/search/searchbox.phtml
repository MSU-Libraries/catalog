<?php
    // MSU - PC-584
    // Determine if this is a search results page
    // If so, we will retain existing search filters on subsequent searches
    // otherwise they will be cleared
    $isResultsPage = (
        str_contains($_SERVER['REQUEST_URI'], '/Results') ||
        str_contains($_SERVER['REQUEST_URI'], '/EDS/Search')
    );

    // Initialize from current search (if available and not explicitly overridden) or defaults:
    if ($this->results === null && $isResultsPage) { // MSU
      $fromSearchMemory = true;
      $results = $this->searchMemory()->getCurrentSearch();
    } else {
      $fromSearchMemory = false;
      $results = $this->results;
    }
    if ($results && $isResultsPage) { // MSU
      $params = $results->getParams();
      $this->searchClassId = $params->getSearchClassId();
    } else {
      $params = null;
      $this->searchClassId ??= $this->config()->get('config')->Site->defaultSearchBackend
        ?? 'Solr';
    }
    // Initialize from current search if eligible, defaults otherwise:
    if (isset($params) && $this->searchClassId === $params->getSearchClassId() && !$params->isSpecializedSearch() && $isResultsPage) { // MSU
      $hiddenFilters = $params->getHiddenFilters();
      $lastSort = $params->getSort();
      $lastLimit = $params->getLimit();
      $options = $params->getOptions();
    } else {
      $hiddenFilters = $this->searchTabs()->getHiddenFilters($this->searchClassId, true, $this->ignoreHiddenFiltersInRequest ?? false);
      $lastSort = $this->searchMemory()->getLastSort($this->searchClassId);
      $lastLimit = $this->searchMemory()->getLastLimit($this->searchClassId);
      $options = $this->searchOptions($this->searchClassId);
    }
    // Override search class ID with searchbox-specific settings, if necessary:
    $overrideSearchClassId = $options->getSearchBoxSearchClassId();
    if ($overrideSearchClassId !== $this->searchClassId) {
      $this->searchClassId = $overrideSearchClassId;
      $options = $this->searchOptions($overrideSearchClassId);
    }

    // Load search actions and settings (if any):
    $keyboardLayouts = $this->searchbox()->getKeyboardLayouts();
    $handlers = $this->searchbox()->getHandlers(
        $this->searchClassId,
        $this->searchIndex ?? null
    );
    $handlerCount = count($handlers);
    $basicSearch = $this->searchbox()->combinedHandlersActive() ? 'combined-searchbox' : $options->getSearchAction();
    $searchHome = $options->getSearchHomeAction();
    $advSearch = $options->getAdvancedSearchAction();

    if (!isset($this->filterList) || !isset($this->checkboxFilters) && $isResultsPage) { // MSU
        $params ??= $this->searchMemory()->getLastSearchParams($this->searchClassId);
        $filterList = $params->getFilterList(true);
        $checkboxFilters = $params->getCheckboxFacets();
    } else {
        $filterList = is_array($this->filterList) ? $this->filterList : [];
        $checkboxFilters = is_array($this->checkboxFilters) ? $this->checkboxFilters : [];
    }
    $filterDetails = $isResultsPage ? $this->searchbox()->getFilterDetails($filterList, $checkboxFilters) : []; // MSU
    $showFilters = $filterDetails && ($results || $options->getRetainFilterSetting()) && $isResultsPage; // MSU
?>
<?php $tabConfig = $this->searchTabs()->getTabConfig($this->searchClassId, $this->lookfor, $this->searchIndex, $this->searchType, $hiddenFilters); ?>
<?php if ($this->searchType == 'advanced'): ?>
  <div class="navbar-form navbar-left flip">
    <?php $tabs = $this->context($this)->renderInContext('search/searchTabs', ['searchTabs' => $tabConfig['tabs'], 'showCounts' => false]); ?>
    <?php if (!empty($tabs)): ?><?=$tabs ?><div class="tab-content clearfix"><?php endif; ?>
      <?php /** MSU Code removed */ ?>
      <p class="adv_search_links">
        <a href="<?=$this->url($advSearch)?>?edit=<?=$this->escapeHtmlAttr($this->searchId)?>"><?=$this->transEsc('Edit this Advanced Search')?></a> |
        <a href="<?=$this->url($advSearch, [], ['query' => $hiddenFilters])?>"><?=$this->transEsc('Start a new Advanced Search')?></a> |
        <a href="<?=$this->url($searchHome, [], ['query' => $hiddenFilters])?>"><?=$this->transEsc('Start a new Basic Search')?></a>
      </p>
      <?=
        $this->context($this)->renderInContext(
            'search/filters.phtml',
            [
              'params' => $params ?? null,
              'urlQuery' => isset($results) ? $results->getUrlQuery() : null,
              'filterList' => $showFilters ? $filterList : [],
              'checkboxFilters' => $showFilters ? $checkboxFilters : [],
              'searchClassId' => $this->searchClassId,
              'searchType' => $this->searchType,
              'fromSearchMemory' => $fromSearchMemory,
            ]
        );
      ?>
    <?php if (!empty($tabs)): ?></div><?php endif; ?>
  </div>
<?php else: ?>
  <div class="keyboard-box">
    <div class="simple-keyboard"></div>
  </div>
  <form id="searchForm" class="searchForm navbar-form navbar-left flip" method="get" action="<?=$this->url($basicSearch)?>" name="searchForm" autocomplete="off">
    <?= $this->context($this)->renderInContext('search/searchTabs', ['searchTabs' => $tabConfig['tabs'], 'showCounts' => $tabConfig['showCounts']]); ?>
    <div class="searchForm-inputs">
      <?php
        // Note: we need type="text" for autocomplete role="combobox"
        $searchboxAttributes = [
          'id' => 'searchForm_lookfor',
          'class' => 'searchForm_lookfor form-control search-query',
          'type' => 'text',
          'name' => 'lookfor',
          'value' => $this->lookfor,
          'aria-label' => $this->translate('search_terms'),
        ];
        if ($placeholder = $this->searchbox()->getPlaceholderText($tabConfig['selected']['id'] ?? $this->searchClassId)) {
          $searchboxAttributes['placeholder'] = $this->translate($placeholder);
        }
        if ($this->searchbox()->autocompleteEnabled($this->searchClassId)) {
          $searchboxAttributes['class'] .= " autocomplete searcher:{$this->searchClassId}"
            . ($this->searchbox()->autocompleteAutoSubmit($this->searchClassId) ? ' ac-auto-submit' : '');
          $searchboxAttributes['data-autocomplete-formatting-rules'] = $this->searchbox()->autocompleteFormattingRulesJson($this->searchClassId);
        }
        if (!empty($keyboardLayouts)) {
          $searchboxAttributes['class'] .= ' with-keyboard-selection';
        }
      ?>
      <?php /** MSU Code moved below */ ?>
      <?php if ($handlerCount > 1): ?>
        <label for="searchForm_type">Search&nbsp;</label><?php /** MSU - class for spacing */ ?>
        <select id="searchForm_type" class="searchForm_type form-control" name="type" data-native-menu="false" aria-label="<?=$this->transEscAttr('Search type')?>">
          <?php $currentGroup = $insideGroup = false; ?>
          <?php foreach ($handlers as $handler): ?>
            <?php
              if ($currentGroup !== ($handler['group'] ?? false)) {
                $currentGroup = $handler['group'];
                if ($insideGroup) {
                  echo '</optgroup>';
                }
                if ($currentGroup) {
                  echo '<optgroup label="' . $this->escapeHtmlAttr($currentGroup) . '">';
                  $insideGroup = true;
                } else {
                  $insideGroup = false;
                }
              }
            ?>
            <option value="<?=$this->escapeHtmlAttr($handler['value'])?>"<?=$handler['selected'] ? ' selected="selected"' : ''?>><?=$handler['indent'] ? '-- ' : ''?><?=$this->transEsc($handler['label'])?></option>
          <?php endforeach; ?>
          <?php if ($insideGroup): ?>
            </optgroup>
          <?php endif; ?>
        </select>
        <label for="searchForm_lookfor">&nbsp;for&nbsp;</label><?php /** MSU */ ?>
        <?php /** MSU - The following div block has been moved from above */ ?>
        <div class="searchForm-query">
          <input<?=$this->htmlAttributes($searchboxAttributes)?>>
          <div id="searchForm_controls">
            <button id="searchForm-reset" class="searchForm-reset hidden" type="reset" tabindex="-1" aria-label="<?=$this->transEscAttr('searchform_reset_button')?>"><?=$this->icon('ui-reset-search');?></button>
            <?php /** MSU Start - add info icon for search bar at desktop */ ?>
            <a href="/Help/Home?topic=search&amp;_=1716862211" data-lightbox="" class="search-tips-icon" title="Search Tips" aria-label="Search Tips"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-info"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            </a>
            <?php /** MSU End */ ?>
            <?php if (!empty($keyboardLayouts)): ?>
              <?php
              $this->assetManager()->appendScriptLink('vendor/js.cookie.js');
              $this->assetManager()->appendScriptLink('vendor/simple-keyboard/index.js');
              $this->assetManager()->appendScriptLink('vendor/simple-keyboard-layouts/index.js');
              $this->assetManager()->appendStyleLink('vendor/simple-keyboard/index.css');
              ?>
              <div class="keyboard-selection dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="keyboard-selection-button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <?=$this->icon('keyboard-o') ?>
                  <?=$this->icon('caret-down') ?>
                </button>
                <ul class="dropdown-menu" aria-labelledby="keyboard-selection-button">
                  <li>
                    <a class="dropdown-item keyboard-selection-item" href="#" data-value="none"><?= $this->transEsc('None') ?></a>
                  </li>
                  <?php foreach ($keyboardLayouts as $keyboardLayout): ?>
                    <li>
                      <a class="keyboard-selection-item" href="#" data-value="<?= $this->escapeHtmlAttr($keyboardLayout) ?>"><?= $this->transEsc("KeyboardLayout::$keyboardLayout") ?></a>
                    </li>
                  <?php endforeach; ?>
                </ul>
              </div>
            <?php endif; ?>
          </div>
        </div>
      <?php elseif ($handlerCount == 1): ?>
        <input type="hidden" name="type" value="<?=$this->escapeHtmlAttr($handlers[0]['value'])?>">
      <?php endif; ?>
      <button type="submit" class="btn btn-primary"><?=$this->icon('search') ?> <?=$this->transEsc('Search')?></button><?php /** MSU */ ?>
      <?php if ($advSearch): ?>
        <?php
          $advSearchQuery = $results ? ['edit' => $results->getSearchId()] : $hiddenFilters;
          $advSearchLink = $this->url($advSearch, [], ['query' => $advSearchQuery]);
        ?>
        <a href="<?=$advSearchLink?>" class="advanced-search-link btn btn-link" rel="nofollow"><?=$this->transEsc('Advanced')?></a>
      <?php endif; ?>
      <a class="search-tips-mobile" href="/Help/Home?topic=search&amp;_=1716862211">Search Tips</a><?php /** MSU - added search tips link for mobile */ ?>
      <?php if ($geoUrl = $this->geocoords()->getSearchUrl($options)) : ?>
          <a href="<?=$geoUrl ?>" class="btn btn-link"><?=$this->transEsc('Geographic Search')?></a>
      <?php endif; ?>

      <?php $shards = $options->getShards(); ?>
      <?php if ($options->showShardCheckboxes() && !empty($shards)): ?>
        <?php
        $selectedShards = $this->selectedShards ?? $options->getDefaultSelectedShards();
        ?>
        <br>
        <?php foreach ($shards as $shard => $val): ?>
          <?php $isSelected = empty($selectedShards) || in_array($shard, $selectedShards); ?>
            <input type="checkbox" <?=$isSelected ? 'checked="checked" ' : ''?>name="shard[]" value='<?=$this->escapeHtmlAttr($shard)?>'> <?=$this->transEsc($shard)?>
        <?php endforeach; ?>
      <?php endif; ?>
      <?php if (($hasDefaultsApplied ?? false) || !empty($filterDetails)): ?>
        <?php if ($options->getRetainFilterSetting()): ?>
          <?php foreach ($filterDetails as $current): ?>
            <input class="applied-filter" id="<?=$this->escapeHtmlAttr($current['id'])?>" type="hidden" name="filter[]" value="<?=$this->escapeHtmlAttr($current['value'])?>">
          <?php endforeach; ?>
          <?php if ($hasDefaultsApplied ?? false): ?>
            <input class="applied-filter" id="dfApplied" type="hidden" name="dfApplied" value="1">
          <?php endif; ?>
        <?php endif; ?>
      <?php endif; ?>
      <?php foreach ($hiddenFilters as $key => $filter): ?>
        <?php foreach ($filter as $value): ?>
          <input type="hidden" name="hiddenFilters[]" value="<?=$this->escapeHtmlAttr($key) . ':' . $this->escapeHtmlAttr('"' . $value . '"')?>">
        <?php endforeach; ?>
      <?php endforeach; ?>
      <?php
        /* Show hidden field for active search class when in combined handler mode. */
        if ($this->searchbox()->combinedHandlersActive()) {
          echo '<input type="hidden" name="activeSearchClassId" value="' . $this->escapeHtmlAttr($this->searchClassId) . '">';
        }
        /* Load hidden limit preference from Session */
        if (!empty($lastLimit)) {
          echo '<input type="hidden" name="limit" value="' . $this->escapeHtmlAttr($lastLimit) . '">';
        }
        if (!empty($lastSort) && $lastSort !== $params?->getDefaultSort()) {
          echo '<input type="hidden" name="sort" value="' . $this->escapeHtmlAttr($lastSort) . '">';
        }
      ?>
    </div>
    <?=$this->context($this)->renderInContext(
          'search/filters.phtml',
          [
            'params' => $params ?? null,
            'urlQuery' => isset($results) && $isResultsPage ? $results->getUrlQuery() : null, // MSU
            'filterList' => $showFilters ? $filterList : [],
            'checkboxFilters' => $showFilters ? $checkboxFilters : [],
            'searchClassId' => $this->searchClassId,
            'searchType' => $this->searchType,
            'fromSearchMemory' => $fromSearchMemory,
          ]
      );?>
  </form>
<?php endif; ?>
