---
x-mariadb-envs: &mariadb_envs
  TZ: America/Detroit
  MARIADB_GALERA_CLUSTER_ADDRESS: gcomm://galera1,galera2,galera3
  MARIADB_ROOT_PASSWORD: 12345
  MARIADB_GALERA_MARIABACKUP_PASSWORD: 123456
  MARIADB_DATABASE: vufind
  MARIADB_USER: vufind
  MARIADB_PASSWORD: vufind
  MARIADB_SKIP_TEST_DB: "yes"
  MARIADB_EXTRA_FLAGS: --old_passwords=OFF --default-authentication-plugin=mysql_native_password --secure_auth=ON

version: "3.8"
services:
  galera1:
    image: bitnami/mariadb-galera:10.6
    networks:
      - internal
    environment:
      SHUTDOWN_DELAY: 1
      # This flag is required when cold-starting the cluster
      MARIADB_GALERA_CLUSTER_BOOTSTRAP: "yes"
      # This flag is only needed when starting cluster from node where grastate.dat has "safe_to_bootstrap: 0"
      MARIADB_GALERA_FORCE_SAFETOBOOTSTRAP: "yes"
      <<: *mariadb_envs
    volumes:
      - bitnami1:/bitnami
      # TODO -- This will only work if the repo is cloned on all nodes
      - /opt/catalog/db:/docker-entrypoint-initdb.d
    stop_grace_period: 60s
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        window: 60s
      labels:
        - "traefik.enable=true"
        - "traefik.tcp.services.msul-galera1-app.loadbalancer.server.port=3306"
      # TODO -- docker node update --label-add nodeid=1 to add support for which service
      # to run on which node
      #placement:
      #  constraints:
      #    - nodeid=1


networks:
  internal:
    name: internal
    external: true

volumes:
  bitnami1:
    # TODO -- eventually these will be external and only be 1 shared bitnami volume
    #external: true
    #name: catalog_bitnami1
  bitnami2:
  bitnami3:
