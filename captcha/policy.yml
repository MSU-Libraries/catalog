networks:
  # Networks will get included from snippets

  malicious:
    # Known IP ranges where malicious (or just plain rude) traffic has originated from
    - prefixes:
      # Tencent
      - "43.128.0.0/10"
      - "101.32.0.0/14"
      - "123.206.0.0/15"
      - "122.51.0.0/16"
      - "49.232.0.0/14"
      # Alibaba Cloud
      - "8.208.0.0/12"
      - "47.76.0.0/16"
      - "47.82.8.0/22"
      - "47.80.0.0/13"
      - "47.76.0.0/14"
      # Huawei Cloud
      - "119.8.160.0/19"
      - "124.243.128.0/18"
      - "1.92.0.0/16"
      - "27.106.96.0/20"
      - "46.250.168.0/21"
      - "94.74.80.0/20"
      - "94.74.96.0/20"
      - "94.74.112.0/21"
      - "94.74.120.0/21"
      - "101.44.16.0/20"
      - "101.46.0.0/20"
      - "111.119.192.0/20"
      - "111.119.208.0/20"
      - "116.204.0.0/18"
      - "116.204.64.0/18"
      - "121.37.0.0/16"
      - "121.91.168.0/22"
      - "122.8.176.0/20"
      - "159.138.0.0/16"
      - "166.108.192.0/19"
      - "189.1.224.0/19"
      - "190.92.192.0/19"
      # Ether.Net
      - "69.176.80.0/20"
      # Zenlayer Cloud
      - "45.40.48.0/20"
      # SCALE IT
      - "45.93.184.0/23"
      - "45.89.148.0/23"
      # China Mobile Communications:
      - "36.128.0.0/10"
      - "117.48.148.0/22"
      - "223.64.0.0/10"
      - "36.128.0.0/10"
      - "111.0.0.0/10"
      - "120.192.0.0/10"
      - "39.128.0.0/10"
      - "183.192.0.0/10"
      - "112.0.0.0/10"
      - "117.128.0.0/10"
      # CHINANET
      - "223.144.0.0/12"
      # China Unicom
      - "42.224.0.0/12"
      - "115.48.0.0/12"
      # TODO more mostly China IP addresses needing to be sorted/categorized
      # - 1.188.0.0/14
      # - 8.208.0.0/12
      # - 14.16.0.0/12
      # - 14.144.0.0/12
      # - 23.239.183.0/24
      # - 23.239.187.0/24
      # - 27.16.0.0/12
      # - 27.152.0.0/17
      # - 27.184.0.0/13
      # - 27.192.0.0/11
      # - 27.224.0.0/14
      # - 42.52.0.0/14
      # - 42.176.0.0/13
      # - 49.64.0.0/11
      # - 58.56.0.0/14
      # - 58.244.0.0/15
      # - 60.0.0.0/12
      # - 60.16.0.0/13
      # - 60.181.0.0/16
      # - 60.208.0.0/12
      # - 60.220.0.0/14
      # - 64.57.129.0/24
      # - 85.254.140.0/24
      # - 101.16.0.0/12
      # - 101.44.176.0/20
      # - 101.72.0.0/14
      # - 104.200.66.0/24
      # - 104.233.38.0/24
      # - 106.8.0.0/15
      # - 106.112.0.0/13
      # - 110.181.0.0/16
      # - 110.240.0.0/12
      # - 111.72.0.0/13
      # - 111.85.0.0/16
      # - 111.119.224.0/20
      # - 111.160.0.0/13
      # - 112.80.0.0/13
      # - 112.96.0.0/15
      # - 112.132.64.0/18
      # - 112.224.0.0/11
      # - 113.0.0.0/13
      # - 113.27.0.0/19
      # - 113.56.0.0/15
      # - 113.64.0.0/11
      # - 113.96.0.0/12
      # - 113.112.0.0/13
      # - 113.120.0.0/13
      # - 113.136.0.0/13
      # - 113.220.0.0/14
      # - 113.224.0.0/12
      # - 113.248.0.0/14
      # - 114.96.0.0/13
      # - 114.224.0.0/12
      # - 114.240.0.0/12
      # - 115.222.0.0/15
      # - 116.8.0.0/14
      # - 116.95.80.0/21
      # - 116.128.0.0/10
      # - 118.73.224.0/20
      # - 119.13.80.0/21
      # - 119.108.0.0/15
      # - 119.128.0.0/12
      # - 119.176.0.0/12
      # - 120.0.0.0/12
      # - 120.40.0.0/14
      # - 120.80.0.0/13
      # - 121.8.0.0/13
      # - 121.16.0.0/13
      # - 122.4.0.0/14
      # - 122.96.0.0/15
      # - 122.156.0.0/14
      # - 122.240.0.0/16
      # - 123.8.0.0/13
      # - 123.52.0.0/14
      # - 123.97.0.0/17
      # - 123.128.0.0/13
      # - 123.152.0.0/13
      # - 123.168.0.0/14
      # - 123.174.0.0/16
      # - 124.76.0.0/14
      # - 124.228.0.0/14
      # - 124.234.0.0/15
      # - 124.236.0.0/14
      # - 124.240.0.0/17
      # - 124.240.98.0/23
      # - 139.202.0.0/16
      # - 139.214.0.0/16
      # - 144.255.0.0/16
      # - 162.128.0.0/16
      # - 166.108.192.0/18
      # - 171.208.0.0/12
      # - 175.30.0.0/15
      # - 175.148.0.0/14
      # - 175.160.0.0/12
      # - 180.96.0.0/11
      # - 180.152.0.0/13
      # - 182.32.0.0/12
      # - 182.112.0.0/12
      # - 182.200.0.0/13
      # - 182.240.0.0/13
      # - 183.0.0.0/10
      # - 183.128.0.0/12
      # - 183.148.0.0/16
      # - 183.156.0.0/14
      # - 183.160.0.0/13
      # - 183.191.224.0/20
      # - 198.145.59.0/2
      # - 202.100.0.0/18
      # - 209.99.160.0/24
      # - 218.7.0.0/14
      # - 218.17.213.0/30
      # - 218.24.0.0/15
      # - 218.90.0.0/13
      # - 219.128.0.0/12
      # - 220.249.144.0/20
      # - 221.192.0.0/14
      # - 221.206.0.0/16
      # - 221.216.0.0/13
      # - 222.85.0.0/17
      # - 222.92.0.0/14
      # - 222.136.0.0/13
      # - 222.240.0.0/13
      # - 1.192.0.0/13
      # - 112.100.0.0/14
      # - 115.204.0.0/15
      # - 116.78.0.0/15
      # - 118.112.0.0/13
      # - 119.112.0.0/13
      # - 119.120.0.0/13
      # - 123.184.0.0/14
      # - 171.80.0.0/14
      # - 211.141.160.0/17
      # - 1.56.0.0/13
      # - 1.202.0.0/15
      # - 27.152.0.0/13
      # - 36.32.0.0/14
      # - 36.96.0.0/11
      # - 42.63.0.0/16
      # - 42.202.0.0/15
      # - 58.17.0.0/17
      # - 58.242.160.0/20
      # - 58.248.0.0/13
      # - 59.52.0.0/14
      # - 61.159.128.0/18
      # - 61.169.0.0/14
      # - 101.64.0.0/13
      # - 110.183.0.0/16
      # - 112.88.0.0/13
      # - 113.200.0.0/15
      # - 114.104.0.0/14
      # - 115.224.0.0/16
      # - 115.229.0.0/16
      # - 116.4.0.0/14
      # - 116.207.0.0/16
      # - 116.208.0.0/14
      # - 117.40.0.0/14
      # - 118.78.0.0/20
      # - 118.80.96.0/20
      # - 118.239.0.0/16
      # - 119.62.0.0/16
      # - 119.164.0.0/14
      # - 119.248.0.0/14
      # - 121.28.0.0/15
      # - 121.32.0.0/14
      # - 121.60.0.0/14
      # - 121.224.0.0/12
      # - 122.51.0.0/16
      # - 122.224.0.0/12
      # - 123.4.0.0/14
      # - 123.101.0.0/16
      # - 123.138.94.0/24
      # - 123.139.168.0/24
      # - 123.164.0.0/14
      # - 124.128.0.0/13
      # - 125.119.0.0/16
      # - 139.209.0.0/16
      # - 144.52.0.0/16
      # - 180.160.0.0/12
      # - 211.143.144.0/17
      # - 218.7.0.0/14
      # - 218.22.0.0/15
      # - 218.27.0.0/16
      # - 218.56.0.0/14
      # - 219.154.0.0/14
      # - 220.166.0.0/15
      # - 221.207.64.0/16
      # - 221.208.0.0/13
      # - 223.11.0.0/16
      # - 1.48.0.0/15
      # - 1.80.0.0/13
      # - 1.180.0.0/14
      # - 14.104.0.0/13
      # - 14.112.0.0/12
      # - 14.208.0.0/12
      # - 27.38.0.0/16
      # - 27.40.0.0/13
      # - 27.128.0.0/15
      # - 36.4.0.0/14
      # - 36.40.0.0/13
      # - 36.56.0.0/13
      # - 36.249.192.0/18
      # - 39.64.0.0/11
      # - 42.4.0.0/14
      # - 42.48.0.0/15
      # - 42.56.0.0/14
      # - 42.88.0.0/13
      # - 42.184.0.0/15
      # - 42.248.0.0/13
      # - 49.232.0.0/14
      # - 58.16.0.0/16
      # - 58.19.0.0/16
      # - 58.42.160.0/19
      # - 58.44.0.0/14
      # - 58.208.0.0/12
      # - 58.242.49.0/21
      # - 59.32.0.0/12
      # - 59.51.128.0/17
      # - 60.24.0.0/13
      # - 60.166.0.0/12
      # - 61.130.192.0/19
      # - 61.139.192.0/18
      # - 61.158.0.0/17
      # - 61.179.0.0/16
      # - 61.240.0.0/14
      # - 101.44.64.0/20
      # - 101.80.0.0/12
      # - 101.204.0.0/14
      # - 106.32.0.0/12
      # - 106.56.0.0/13
      # - 106.224.0.0/12
      # - 110.6.160.0/20
      # - 110.52.0.0/15
      # - 110.88.0.0/14
      # - 110.182.0.0/16
      # - 110.228.0.0/14
      # - 110.238.104.0/21
      # - 111.119.240.0/20
      # - 111.176.0.0/13
      # - 111.192.0.0/12
      # - 111.224.0.0/14
      # - 112.112.0.0/14
      # - 112.116.0.0/15
      # - 112.123.80.0/20
      # - 113.12.0.0/14
      # - 113.16.0.0/15
      # - 113.132.0.0/14
      # - 113.204.0.0/14
      # - 113.218.0.0/15
      # - 113.240.0.0/13
      # - 114.80.0.0/12
      # - 114.216.0.0/13
      # - 115.194.0.0/15
      # - 115.203.0.0/16
      # - 115.211.0.0/16
      # - 115.234.0.0/15
      # - 116.1.0.0/16
      # - 116.16.0.0/12
      # - 117.8.0.0/13
      # - 117.24.0.0/13
      # - 117.80.0.0/12
      # - 118.73.112.0/20
      # - 118.77.144.0/20
      # - 118.120.0.0/14
      # - 119.2.128.0/17
      # - 119.8.32.0/19
      # - 119.32.0.0/14
      # - 119.36.129.0/24
      # - 119.48.0.0/13
      # - 120.32.0.0/13
      # - 121.24.0.0/14
      # - 121.91.172.0/22
      # - 122.136.0.0/13
      # - 122.192.112.0/24
      # - 123.97.128.0/17
      # - 123.112.0.0/12
      # - 123.139.44.0/22
      # - 123.172.0.0/15
      # - 123.178.0.0/15
      # - 123.180.0.0/14
      # - 123.244.0.0/14
      # - 124.67.0.0/16
      # - 124.89.103.0/24
      # - 124.90.0.0/15
      # - 124.92.0.0/14
      # - 124.167.48.0/20
      # - 125.33.0.0/16
      # - 125.40.0.0/13
      # - 125.64.0.0/13
      # - 125.79.0.0/16
      # - 125.107.0.0/17
      # - 125.112.128.0/17
      # - 125.113.0.0/16
      # - 139.170.0.0/16
      # - 139.211.0.0/16
      # - 139.213.0.0/16
      # - 139.215.0.0/16
      # - 140.240.0.0/16
      # - 140.250.0.0/16
      # - 140.255.0.0/16
      # - 150.40.192.0/18
      # - 153.0.0.0/8
      # - 163.125.0.0/16
      # - 163.204.0.0/16
      # - 171.8.0.0/13
      # - 171.34.0.0/15
      # - 171.112.0.0/14
      # - 171.116.0.0/14
      # - 175.0.0.0/12
      # - 175.16.0.0/13
      # - 175.44.0.0/19
      # - 175.152.0.0/14
      # - 180.136.0.0/13
      # - 182.96.0.0/12
      # - 182.128.0.0/12
      # - 182.144.0.0/13
      # - 183.87.32.0/20
      # - 183.92.0.0/14
      # - 183.191.128.0/20
      # - 189.1.192.0/19
      # - 190.92.224.0/19
      # - 211.140.192.0/18
      # - 218.10.0.0/16
      # - 218.19.0.0/15
      # - 218.21.128.0/17
      # - 218.86.128.0/17
      # - 218.200.0.0/13
      # - 218.200.0.0/14
      # - 220.160.0.0/14
      # - 220.192.0.0/12
      # - 221.0.0.0/14
      # - 221.6.172.0/24
      # - 221.13.128.0/14
      # - 221.200.0.0/14
      # - 221.224.0.0/13
      # - 222.76.0.0/14
      # - 222.90.0.0/15
      # - 222.132.0.0/14
      # - 222.160.0.0/14
      # - 222.219.0.0/14
      # - 223.12.0.0/16
      # - 223.212.0.0/15
      # - 223.220.0.0/15
  academic:
    - prefixes:
      # Merit Network
      - "35.0.0.0/12"
      - "35.16.0.0/16"
      - "35.20.0.0/14"
      - "35.24.0.0/15"
      - "35.25.0.0/16"
      - "35.37.0.0/16"
      - "35.38.0.0/16"
      - "35.40.0.0/16"
      - "35.58.0.0/16"
      - "35.62.0.0/16"
      - "35.63.0.0/16"
      - "35.64.0.0/14"
      - "35.68.0.0/15"
      - "35.70.0.0/16"
      - "141.210.0.0/16"
      - "141.217.0.0/16"
      - "141.218.0.0/16"
      - "148.61.0.0/16"
      - "164.76.0.0/16"
      - "198.108.0.0/14"
      - "204.38.0.0/16"
      - "207.72.0.0/14"
  isp:
    - prefixes:
      # Comcast
      - "24.0.0.0/12"
      - "50.128.0.0/9"
      - "67.160.0.0/11"
      - "68.32.0.0/11"
      - "69.240.0.0/12"
      - "71.192.0.0/12"
      - "71.224.0.0/12"
      - "73.0.0.0/8"
      - "74.16.0.0/12"
      - "76.16.0.0/12"
      - "76.96.0.0/11"
      - "76.128.0.0/11"
      - "96.64.0.0/11"
      - "96.96.0.0/12"
      - "96.128.0.0/11"
      - "96.192.0.0/11"
      - "98.32.0.0/11"
      - "98.192.0.0/10"
      - "174.48.0.0/12"
      - "174.160.0.0/11"
      - "184.112.0.0/12"
      # Metronet
      - "46.110.0.0/16"
      - "52.144.32.0/21"
      - "52.144.112.0/21"
      - "64.131.0.0/18"
      - "69.174.128.0/19"
      - "69.174.160.0/20"
      - "104.218.144.0/21"
      - "104.254.216.0/21"
      - "139.60.120.0/21"
      - "147.92.96.0/20"
      - "149.20.176.0/21"
      - "149.154.0.0/18"
      - "152.117.64.0/18"
      - "162.211.32.0/21"
      - "162.221.216.0/21"
      - "172.87.16.0/21"
      - "174.137.80.0/20"
      - "184.170.160.0/20"
      - "192.69.176.0/21"
      - "192.198.56.0/21"
      - "195.252.192.0/18"
      - "199.27.248.0/21"
      - "199.66.64.0/21"
      - "199.168.72.0/21"
      - "199.204.80.0/21"
      - "206.196.32.0/19"
      - "206.225.72.0/21"
      - "208.38.224.0/19"
      - "208.64.168.0/21"
      - "208.110.224.0/20"
      - "209.173.192.0/19"
      - "209.173.224.0/20"
      - "216.82.0.0/18"
      - "216.173.160.0/19"
      - "217.180.192.0/18"
      # AT&T
      - "12.112.0.0/13"
      - "23.112.0.0/12"
      - "32.0.0.0/9"
      - "32.128.0.0/12"
      - "32.176.0.0/13"
      - "32.224.0.0/13"
      - "32.248.0.0/13"
      - "45.16.0.0/12"
      - "63.192.0.0/12"
      - "64.160.0.0/12"
      - "65.64.0.0/13"
      - "66.120.0.0/13"
      - "66.136.0.0/13"
      - "67.112.0.0/12"
      - "68.88.0.0/13"
      - "68.120.0.0/13"
      - "68.248.0.0/13"
      - "69.144.0.0/13"
      - "69.210.128.0/17"
      - "69.211.0.0/16"
      - "69.212.0.0/14"
      - "69.216.0.0/13"
      - "70.132.64.0/18"
      - "70.132.128.0/17"
      - "70.133.0.0/16"
      - "70.134.0.0/15"
      - "70.136.0.0/13"
      - "70.144.0.0/13"
      - "70.240.128.0/17"
      - "70.241.0.0/16"
      - "70.242.0.0/15"
      - "70.244.0.0/14"
      - "70.248.0.0/15"
      - "70.250.0.0/16"
      - "70.251.0.0/18"
      - "75.3.192.0/18"
      - "75.4.0.0/14"
      - "75.8.0.0/13"
      - "75.16.0.0/14"
      - "75.20.0.0/15"
      - "75.22.0.0/17"
      - "75.22.128.0/18"
      - "75.23.0.0/16"
      - "75.24.0.0/13"
      - "75.32.0.0/13"
      - "75.40.0.0/14"
      - "75.44.0.0/16"
      - "75.45.0.0/17"
      - "75.47.192.0/18"
      - "75.48.0.0/12"
      - "76.211.64.0/18"
      - "76.211.128.0/17"
      - "76.212.0.0/14"
      - "76.216.0.0/14"
      - "76.220.0.0/15"
      - "76.222.0.0/16"
      - "76.223.192.0/18"
      - "76.224.0.0/13"
      - "76.232.0.0/14"
      - "76.236.0.0/15"
      - "76.241.128.0/17"
      - "76.242.0.0/15"
      - "76.244.0.0/14"
      - "76.248.0.0/14"
      - "99.0.0.0/13"
      - "99.8.0.0/15"
      - "99.10.64.0/18"
      - "99.10.128.0/17"
      - "99.11.0.0/16"
      - "99.12.0.0/14"
      - "99.16.0.0/12"
      - "99.32.0.0/11"
      - "99.64.0.0/13"
      - "99.72.0.0/15"
      - "99.74.0.0/16"
      - "99.75.0.0/17"
      - "99.75.128.0/18"
      - "99.87.192.0/18"
      - "99.88.0.0/13"
      - "99.96.0.0/13"
      - "99.104.0.0/16"
      - "99.105.0.0/17"
      - "99.105.192.0/18"
      - "99.106.0.0/15"
      - "99.108.0.0/14"
      - "99.112.0.0/12"
      - "99.128.0.0/13"
      - "99.136.0.0/14"
      - "99.140.0.0/16"
      - "99.157.0.0/16"
      - "99.158.0.0/15"
      - "99.160.0.0/12"
      - "99.176.0.0/14"
      - "99.180.0.0/16"
      - "99.181.0.0/18"
      - "99.181.128.0/17"
      - "99.182.0.0/15"
      - "99.184.0.0/13"
      - "104.0.0.0/12"
      - "104.48.0.0/12"
      - "104.176.0.0/12"
      - "107.128.0.0/12"
      - "107.192.0.0/11"
      - "107.224.0.0/11"
      - "108.64.0.0/11"
      - "108.144.0.0/13"
      - "108.152.0.0/14"
      - "108.192.0.0/10"
      - "162.192.0.0/12"
      - "162.224.0.0/12"
      - "166.128.0.0/13"
      - "166.136.0.0/15"
      - "166.138.0.0/16"
      - "166.170.0.0/15"
      - "166.172.0.0/14"
      - "166.176.0.0/15"
      - "166.178.0.0/16"
      - "166.179.0.0/18"
      - "166.179.64.0/19"
      - "166.179.96.0/21"
      - "166.179.104.0/22"
      - "166.183.0.0/16"
      - "166.184.0.0/13"
      - "166.192.0.0/12"
      - "166.208.0.0/15"
      - "166.212.0.0/14"
      - "166.216.0.0/14"
      - "166.220.0.0/16"
      - "172.0.0.0/12"
      - "184.128.0.0/12"

challenges:
  # Challenges will get included from snippets

  # Overriding proof-of-work to lower difficulty
  js-pow-sha256:
    runtime: js
    parameters:
      path: "js-pow-sha256"
      js-loader: load.mjs
      wasm-runtime: runtime.wasm
      wasm-runtime-settings:
        difficulty: 15
      verify-probability: 0.02

conditions:
  # Conditions will get replaced on rules AST when found as ($condition-name)
  # Conditions will get included from snippets

  is-network-academic:
    - &is-network-academic 'remoteAddress.network("academic")'

  is-network-isp:
    - &is-network-isp 'remoteAddress.network("isp")'

  is-network-malicious:
    - &is-network-malicious 'remoteAddress.network("malicious")'

  is-static-asset:
    - 'path == "/apple-touch-icon.png"'
    - 'path == "/apple-touch-icon-precomposed.png"'
    - 'path.matches("^/themes/")'
    - 'path.matches("^/Cover/Show")'
    - 'path.matches("\\.(manifest|ttf|woff|woff2|jpg|jpeg|gif|png|webp|avif|svg|mp4|webm|css|js|mjs|wasm)$")'

  is-api-path:
    - 'path.matches("^/api/")'
    - 'path.matches("^/AJAX/")'
    - 'path.matches("^/OAI/")'

  is-tool-ua:
    - 'userAgent.startsWith("python-requests/")'
    - 'userAgent.startsWith("Python-urllib/")'
    - 'userAgent.startsWith("python-httpx/")'
    - 'userAgent.contains("aoihttp/")'
    - 'userAgent.startsWith("http.rb/")'
    - 'userAgent.startsWith("curl/")'
    - 'userAgent.startsWith("Wget/")'
    - 'userAgent.startsWith("libcurl/")'
    - 'userAgent.startsWith("okhttp/")'
    - 'userAgent.startsWith("Java/")'
    - 'userAgent.startsWith("Apache-HttpClient//")'
    - 'userAgent.startsWith("Go-http-client/")'
    - 'userAgent.startsWith("node-fetch/")'
    - 'userAgent.startsWith("Guzzle")'

  is-allowed-agent:
    - 'userAgent.contains("Silktide")'

  is-suspicious-crawler:
    - 'userAgent.contains("Presto/") || userAgent.contains("Trident/")'
    # Old IE browsers
    - 'userAgent.matches("MSIE ([2-9]|10|11)\\.")'
    # Old Linux browsers
    - 'userAgent.matches("Linux i[63]86") || userAgent.matches("FreeBSD i[63]86")'
    # Old Windows browsers
    - 'userAgent.matches("Windows (3|95|98|CE)") || userAgent.matches("Windows NT [1-5]\\.")'
    # Old mobile browsers
    - 'userAgent.matches("Android [1-5]\\.") || userAgent.matches("(iPad|iPhone) OS [1-9]_")'
    # Old generic browsers
    - 'userAgent.startsWith("Opera/")'
    - 'userAgent.matches("^Mozilla/[1-4]")'
    # No user agent set
    - 'userAgent == ""'
    # Detected sus agents
    - 'userAgent.matches("Firefox/[0-9]{1,2}\\.")'
    - 'userAgent.matches("Firefox/1[0-1][0-9]\\.")'
    - 'userAgent.matches("Opera/[0-9]\\.")'
    - 'userAgent.matches("iPhone OS [0-9]_")'
    - 'userAgent.matches("Gecko/1[0-9][0-9][0-9]-")'
    - 'userAgent.matches("Gecko/20[4-9][0-9]-")'
    - 'userAgent.matches("Gecko/2[1-9][0-9][0-9]-")'
    - 'userAgent.matches("Gecko/[03-9][0-9][0-9][0-9]-")'
    - 'userAgent.matches("MSIE [0-9]\\.")'
    - 'userAgent.matches("Windows 9[5-8x]")'
    - 'userAgent.matches("Chrome/[0-9]{1,2}\\.")'
    - 'userAgent.matches("Chrome/11[0-9]\\.")'
    - 'userAgent.matches("Chrome/12[0-4]\\.")'
    - 'userAgent.matches("Android [1-6]\\.")'
    - 'userAgent.matches("Version/[0-9]\\.[0-9](\\.[0-9])? Safari")'
    - 'userAgent.matches("FxiOS/[0-9]{1,2}\\.")'
    - 'userAgent.matches("CriOS/[0-9]{1,2}\\.")'
    - 'userAgent.matches("PPC Mac OS X")'
    - 'userAgent.matches("Windows NT [0-9]\\.[0-9]")'
    - 'userAgent.matches("Trident [0-9]\\.[0-9]")'

# Rules are checked sequentially in order, from top to bottom.
# If a pass action is met, no further rule are checked.
rules:
  - name: allow-private-networks
    conditions:
      - '($is-network-localhost)'
      - '($is-network-private)'
    action: pass

  - name: allow-known-ip-ranges
    conditions:
      - '($is-network-academic)'
      - '($is-network-isp)'
    action: pass

  - name: known-bad-ranges
    conditions:
      - '($is-network-malicious)'
    action: proxy
    settings:
      proxy-backend: "badbots"

  - name: undesired-crawlers
    conditions:
      - '($is-headless-chromium)'
      - 'userAgent.startsWith("Lightpanda/")'
      - 'userAgent.startsWith("masscan/")'
      # Typo'd opera botnet
      - 'userAgent.matches("^Opera/[0-9.]+\\.\\(")'
      # AI bullshit stuff, they do not respect robots.txt even while they read it
      # TikTok Bytedance AI training
      - 'userAgent.contains("Bytedance") || userAgent.contains("Bytespider") || userAgent.contains("TikTokSpider")'
      # Meta AI training; The Meta-ExternalAgent crawler crawls the web for use cases such as training AI models or improving products by indexing content directly.
      - 'userAgent.contains("meta-externalagent/") || userAgent.contains("meta-externalfetcher/") || userAgent.contains("FacebookBot")'
      # Anthropic AI training and usage
      - 'userAgent.contains("ClaudeBot") || userAgent.contains("Claude-User")|| userAgent.contains("Claude-SearchBot")'
      # Common Crawl AI crawlers
      - 'userAgent.contains("CCBot")'
      # ChatGPT AI crawlers https://platform.openai.com/docs/bots
      - 'userAgent.contains("GPTBot") || userAgent.contains("OAI-SearchBot") || userAgent.contains("ChatGPT-User")'
      # Other AI crawlers
      - 'userAgent.contains("Amazonbot") || userAgent.contains("Google-Extended") || userAgent.contains("PanguBot") || userAgent.contains("AI2Bot") || userAgent.contains("Diffbot") || userAgent.contains("cohere-training-data-crawler") || userAgent.contains("Applebot-Extended")'
      # SEO / Ads and marketing
      - 'userAgent.contains("BLEXBot")'
      # Previously detected badly behaved bots; (?i) = case insensitive match
      - 'userAgent.matches("(?i)(AcademicBotRTU|GoogleOther|FriendlyCrawler|SemrushBot|Diffbot|HawaiiBot|DataForSeoBot)")'
    action: proxy
    settings:
      proxy-backend: "badbots"

  - name: allow-well-known-resources
    conditions:
      - '($is-well-known-asset)'
    action: pass

  - name: allow-static-resources
    conditions:
      - '($is-static-asset)'
    action: pass

  - name: desired-crawlers
    conditions:
      - *is-bot-googlebot
      - *is-bot-bingbot
      - *is-bot-duckduckbot
      - *is-bot-kagibot
      - *is-bot-qwantbot
      - *is-bot-yandexbot
    action: pass

  - name: allow-allowed-agents
    conditions:
      - '($is-allowed-agent)'
    action: pass

  - name: allow-api-calls
    conditions:
      - '($is-api-path)'
    action: pass

  - name: suspicious-crawlers
    conditions:
      - '($is-suspicious-crawler)'
    action: none
    children:
      - name: 0
        action: check
        settings:
          challenges: [js-refresh]
      - name: 1
        action: check
        settings:
          challenges: [js-pow-sha256]
      - name: 2
        action: check
        settings:
          challenges: [preload-link, resource-load]
      - name: 3
        action: check
        settings:
          challenges: [header-refresh]

  - name: suspicious-fetchers
    action: check
    settings:
      challenges: [js-refresh]
    conditions:
      - 'userAgent.contains("facebookexternalhit/") || userAgent.contains("facebookcatalog/")'

  # Allow PUT/DELETE/PATCH/POST requests in general
  - name: non-get-request
    action: pass
    conditions:
      - '!(method == "HEAD" || method == "GET")'

  - name: plaintext-browser
    action: challenge
    settings:
      challenges: [meta-refresh, cookie]
    conditions:
      - 'userAgent.startsWith("Lynx/")'
      - 'userAgent.startsWith("Links ")'

  # rules for tools like python requests or PHP Guzzle
  - name: standard-tools
    action: challenge
    settings:
      challenges: [cookie]
    conditions:
      - '($is-tool-ua)'

  - name: standard-browser
    action: challenge
    settings:
      challenges: [preload-link, meta-refresh, resource-load, js-refresh]
    conditions:
      - '($is-generic-browser)'

# If end of rules is reached, default is PASS
