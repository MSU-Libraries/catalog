stages:
  - test
  - Build
  - Deploy
  - Deploy Prod
  - Cleanup
  - Release

variables:
  VUFIND_VERSION: "8.1.1"
  # Used during upgrade, which needs to know previous version
  PREV_VUFIND_VERSION: "8.1"
  SIMPLESAMLPHP_VERSION: "1.19.6"
  DEPLOY_HOST_A: catalog-1.aws.lib.msu.edu
  DEPLOY_HOST_B: catalog-2.aws.lib.msu.edu
  DEPLOY_HOST_C: catalog-3.aws.lib.msu.edu
  COMPOSE_PATH: /home/deploy/$STACK_NAME

Set Stack Name:
  stage: Build
  interruptible: true
  variables:
    PROD: "false"
  rules:
    - if: '($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/ || $CI_PIPELINE_SOURCE == "schedule") && $PROD == "false"'
    - if: '($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == "schedule") && $PROD == "true"'
      when: manual
  script:
    - bash ./cicd/set-stack-name
  artifacts:
    reports:
      dotenv: build.env

Create DNS:
  extends: .stack_template
  image: $CI_REGISTRY_IMAGE/ansible:latest
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
  script:
    - ./cicd/create-dns

Deploy Compose Files:
  extends: .stack_template
  rules:
    - if: '($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == "schedule") && $CI_DEPLOY_FREEZE == null'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
  script:
    - ./cicd/deploy-compose-files

Initialize Database Logs:
  extends: .stack_template
  script:
     - ./cicd/initialize-database-logs

Perform Database Backup:
  extends: .stack_template
  rules:
    - if: '$CI_DEFAULT_BRANCH == $CI_COMMIT_BRANCH && $CI_PIPELINE_SOURCE != "schedule" && $CI_DEPLOY_FREEZE == null'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  script:
    - ./cicd/perform-database-backup

Deploy Internal Network:
  extends: .stack_template
  script:
    - ./cicd/deploy-internal-network

Deploy Traefik:
  extends: .stack_template
  needs:
    - job: Set Stack Name
      artifacts: true
    - Deploy Compose Files
  script:
    - ./cicd/deploy-traefik

Bootstrap Stacks:
  extends: .stack_template
  needs:
    - job: Set Stack Name
      artifacts: true
    - Deploy Compose Files
    - Deploy Internal Network
    - Build DB Image
    - Build Solr Image
    - Perform Database Backup
  script:
    - ./cicd/bootstrap-stacks

Deploy Solr:
  extends: .stack_template
  rules:
    - if: '($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == "schedule") && $CI_DEPLOY_FREEZE == null'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Build Solr Image
    - Build ZK Image
    - Bootstrap Stacks
    - Deploy Compose Files
    - Deploy Internal Network
    - Deploy Traefik
    - Perform Database Backup
  script:
    - ./cicd/deploy-solr

Deploy Swarm Cron:
  extends: .stack_template
  script:
    - ./cicd/deploy-swarm-cron

Deploy DB:
  extends: .stack_template
  rules:
    - if: '($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == "schedule") && $CI_DEPLOY_FREEZE == null'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Build DB Image
    - Bootstrap Stacks
    - Deploy Compose Files
    - Deploy Internal Network
    - Initialize Database Logs
    - Perform Database Backup
  script:
    - ./cicd/deploy-db

Deploy Vufind:
  extends: .stack_template
  environment:
    name: $CI_COMMIT_BRANCH
    url: $URL
    on_stop: Remove Environment
  rules:
    - if: '($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == "schedule") && $CI_DEPLOY_FREEZE == null'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Deploy Traefik
    - Deploy Internal Network
    - Build Vufind Image
    - Deploy DB
    - Deploy Solr
    - Deploy Compose Files
    - Perform Database Backup
  script:
    - ./cicd/deploy-vufind
  artifacts:
    reports:
      dotenv: deploy.env

Deploy Monitoring:
  extends: .stack_template
  rules:
    - if: '($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == "schedule") && $CI_DEPLOY_FREEZE == null'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Build Monitoring Image
    - Deploy Compose Files
    - Deploy Internal Network
    - Deploy Traefik
  script:
    - ./cicd/deploy-monitoring

Verify Vufind Image:
  extends: .stack_template
  needs:
    - job: Set Stack Name
      artifacts: true
    - job: Deploy Vufind
      artifacts: true
  script:
    - ./cicd/verify-vufind-image

Vufind Upgrade:
  extends: .stack_template
  needs:
    - job: Set Stack Name
      artifacts: true
    - job: Deploy Vufind
      artifacts: true
    - Verify Vufind Image
  script:
    - ./cicd/vufind-upgrade

Populate Vufind Environment:
  extends: .stack_template
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Vufind Upgrade
  script:
    - ./cicd/populate-vufind-environment

Verify Health:
  extends: .stack_template
  needs:
    - job: Set Stack Name
      artifacts: true
    - Verify Vufind Image
  script:
    - ./cicd/verify-health

Remove Environment:
  stage: Cleanup
  extends: .stack_template
  image: $CI_REGISTRY_IMAGE/ansible:latest
  environment:
    name: $CI_COMMIT_BRANCH
    action: stop
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
      when: manual
  needs:
    - job: Set Stack Name
      artifacts: true
    - Deploy Vufind
  script:
    - ./cicd/remove-environment

############# Templates ###############

.stack_template:
  stage: Deploy
  tags:
    - msul-shared
  extends: .setup_ssh
  retry: 2
  interruptible: true
  variables:
    ENCODED_PRIVATE_KEY: $DEPLOY_PRIVATE_KEY
    SERVER: $DEPLOY_HOST_A
  rules:
    - if: '($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_PIPELINE_SOURCE == "schedule") && $CI_DEPLOY_FREEZE == null'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Deploy Compose Files
  before_script:
    - ./cicd/before-script

Deploy:
  interruptible: true

include:
  - project: 'msu-libraries/public/cicd-templates'
    ref: main
    file: 'SSH.gitlab-ci.yml'
  - 'templates/*.gitlab-ci.yml'
