stages:
  - test
  - Build
  - Deploy
  - Deploy Prod
  - Cleanup
  - Release

variables:
  VUFIND_VERSION: "9.0.1"
  # Used during upgrade, which needs to know previous version
  PREV_VUFIND_VERSION: "8.1.2"
  SIMPLESAMLPHP_VERSION: "1.19.6"
  DEPLOY_HOST_A: catalog-1.aws.lib.msu.edu
  DEPLOY_HOST_B: catalog-2.aws.lib.msu.edu
  DEPLOY_HOST_C: catalog-3.aws.lib.msu.edu
  COMPOSE_PATH: /home/deploy/$STACK_NAME

Set Stack Name:
  stage: test
  interruptible: true
  variables:
    PROD: "false"
  tags:
    - msul-shared
  rules:
    - if: '($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/) && $PROD == "false"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $PROD == "true"'
      when: manual
  before_script:
    - apk add --no-cache bash
  script:
    - bash ./cicd/set-stack-name
  artifacts:
    reports:
      dotenv: build.env

Create DNS:
  extends: .stack_template
  image: $CI_REGISTRY_IMAGE/ansible:latest
  rules:
    - if: '($CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/) && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Stack Name
      artifacts: true
  script:
    - ./cicd/create-dns

Deploy Compose Files:
  extends: .stack_template
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
  script:
    - bash ./cicd/deploy-compose-files

Initialize Database Logs:
  extends: .stack_template
  script:
     - bash ./cicd/initialize-database-logs

Perform Database Backup:
  extends: .stack_template
  rules:
    - if: '$CI_DEFAULT_BRANCH == $CI_COMMIT_BRANCH && $CI_PIPELINE_SOURCE != "schedule" && $CI_DEPLOY_FREEZE == null'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  script:
    - bash ./cicd/perform-database-backup

Deploy Internal Network:
  extends: .stack_template
  script:
    - bash ./cicd/deploy-internal-network

Deploy Traefik:
  extends: .stack_template
  needs:
    - job: Set Stack Name
      artifacts: true
    - Deploy Compose Files
  script:
    - bash ./cicd/deploy-traefik

Bootstrap Stacks:
  extends: .stack_template
  needs:
    - job: Set Stack Name
      artifacts: true
    - Deploy Compose Files
    - Deploy Internal Network
    - Build DB Image
    - Build Solr Image
    - Perform Database Backup
  script:
    - bash ./cicd/bootstrap-stacks

Deploy Solr:
  extends: .stack_template
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Build Solr Image
    - Build ZK Image
    - Bootstrap Stacks
    - Deploy Compose Files
    - Deploy Internal Network
    - Deploy Traefik
    - Perform Database Backup
  script:
    - bash ./cicd/deploy-solr

Deploy Swarm Cron:
  extends: .stack_template
  script:
    - bash ./cicd/deploy-swarm-cleanup

Deploy DB:
  extends: .stack_template
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Build DB Image
    - Bootstrap Stacks
    - Deploy Compose Files
    - Deploy Internal Network
    - Initialize Database Logs
    - Perform Database Backup
  script:
    - bash ./cicd/deploy-db

Deploy Vufind:
  extends: .stack_template
  environment:
    name: $CI_COMMIT_BRANCH
    url: $URL
    on_stop: Remove Environment
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Deploy Traefik
    - Deploy Internal Network
    - Build Vufind Image
    - Deploy DB
    - Deploy Solr
    - Deploy Compose Files
    - Perform Database Backup
  script:
    - bash ./cicd/deploy-vufind
  artifacts:
    reports:
      dotenv: deploy.env

Deploy Monitoring:
  extends: .stack_template
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Build Monitoring Image
    - Deploy Compose Files
    - Deploy Internal Network
    - Deploy Traefik
  script:
    - bash ./cicd/deploy-monitoring

Verify Stack Health:
  extends: .stack_template
  needs:
    - job: Set Stack Name
      artifacts: true
    - Deploy Monitoring
    - Deploy Vufind
  script:
    - bash ./cicd/verify-stack-health

Vufind Upgrade:
  extends: .stack_template
  needs:
    - job: Set Stack Name
      artifacts: true
    - job: Deploy Vufind
      artifacts: true
    - Verify Stack Health
  script:
    - bash ./cicd/vufind-upgrade

Populate Vufind Environment:
  extends: .stack_template
  rules:
    - if: '($CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/) && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Vufind Upgrade
  script:
    - bash ./cicd/populate-vufind-environment

Run Functional Tests:
  extends: .stack_template
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Verify Stack Health
  script:
    - bash ./cicd/run-functional-tests

Scale Down Catalog Service:
  extends: .stack_template
  rules:
    - if: '($CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/) && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Populate Vufind Environment
  script:
    - bash ./cicd/scale-down-catalog-service

Remove Environment:
  stage: Cleanup
  extends: .stack_template
  image: $CI_REGISTRY_IMAGE/ansible:latest
  environment:
    name: $CI_COMMIT_BRANCH
    action: stop
  rules:
    - if: '($CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/) && $CI_PIPELINE_SOURCE != "schedule"'
      when: manual
  needs:
    - job: Set Stack Name
      artifacts: true
    - Deploy Vufind
  script:
    - ./cicd/remove-environment

############# Templates ###############

.stack_template:
  stage: Deploy
  tags:
    - msul-shared
  retry: 2
  interruptible: true
  variables:
    ENCODED_PRIVATE_KEY: $DEPLOY_PRIVATE_KEY
    SERVER: $DEPLOY_HOST_A
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
    - if: '$CI_COMMIT_BRANCH =~ /^devel-/ || $CI_COMMIT_BRANCH =~ /^review-/'
  needs:
    - job: Set Stack Name
      artifacts: true
    - Deploy Compose Files
  before_script:
    - apk add --no-cache bash || true

include:
  - 'templates/*.gitlab-ci.yml'
