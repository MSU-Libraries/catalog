---
x-mariadb-envs: &mariadb_envs
  TZ: America/Detroit
  MARIADB_GALERA_CLUSTER_ADDRESS: gcomm://galera1,galera2,galera3
  MARIADB_ROOT_PASSWORD: 12345
  MARIADB_GALERA_MARIABACKUP_PASSWORD: 123456
  MARIADB_DATABASE: vufind
  MARIADB_USER: vufind
  MARIADB_PASSWORD: vufind
  MARIADB_SKIP_TEST_DB: "yes"
  MARIADB_CHARACTER_SET: utf8mb4
  MARIADB_COLLATE: utf8mb4_unicode_ci
  MARIADB_EXTRA_FLAGS: --old_passwords=OFF --default-authentication-plugin=mysql_native_password --secure_auth=ON

version: "3.8"
services:
  galera:
    image: registry.gitlab.msu.edu/msu-libraries/devops/catalog/db:${CI_COMMIT_SHORT_SHA}
    hostname: galera{{slice .Node.Hostname 8 9}}
    networks:
      - internal
    environment:
      GALERA_HOST: galera{{slice .Node.Hostname 8 9}}
      # This flag is required when cold-starting the cluster
      MARIADB_GALERA_CLUSTER_BOOTSTRAP: "yes"
      # This flag is only needed when starting cluster from node where grastate.dat has "safe_to_bootstrap: 0"
      #MARIADB_GALERA_FORCE_SAFETOBOOTSTRAP: "yes"
      <<: *mariadb_envs
    volumes:
      - db-bitnami:/bitnami
      - logs:/mnt/logs
    stop_signal: SIGWINCH
    stop_grace_period: 80s
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        window: 90s
      update_config:
        parallelism: 1
        failure_action: rollback
        delay: 150s
        monitor: 20s
      placement:
        max_replicas_per_node: 1

networks:
  internal:
    name: ${STACK_NAME}-internal
    external: true

volumes:
  db-bitnami:
  logs:
    external: true
    name: "${STACK_NAME}_logs"
