############# Prod Deploy ###############
Set Prod Stack Name:
  stage: Deploy
  extends: Set Stack Name
  needs:
    - Build DB Image
    - Build LegacyLinks Image
    - Build Monitoring Image
    - Build Solr Image
    - Build Vufind Image
    - Build ZK Image
  variables:
    PROD: "true"
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $PROD == "true" && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
      when: manual

Deploy Prod Compose Files:
  stage: Deploy Prod
  extends: Deploy Compose Files
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true

Deploy Prod Internal Network:
  stage: Deploy Prod
  extends: Deploy Internal Network
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Compose Files

Initialize Prod Log Dirs:
  stage: Deploy Prod
  extends: Initialize Log Dirs
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Internal Network

Bootstrap Prod Stacks:
  stage: Deploy Prod
  extends: Bootstrap Stacks
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Compose Files
    - Deploy Prod Internal Network

Deploy Prod ZK:
  stage: Deploy Prod
  extends: Deploy ZK
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Bootstrap Prod Stacks

Deploy Prod Solr:
  stage: Deploy Prod
  extends: Deploy Solr
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod ZK
    - Bootstrap Prod Stacks

Deploy Prod DB:
  stage: Deploy Prod
  extends: Deploy DB
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Bootstrap Prod Stacks
    - Initialize Prod Log Dirs

Deploy Prod Vufind:
  stage: Deploy Prod
  extends: Deploy Vufind
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod DB
    - Deploy Prod Solr

Deploy Prod Vufind Build Env:
  stage: Deploy Prod
  extends: Deploy Vufind Build Env
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
      when: manual
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Vufind

Deploy Prod Monitoring:
  stage: Deploy Prod
  extends: Deploy Monitoring
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Internal Network

Verify Prod Stack Health:
  stage: Deploy Prod
  extends: Verify Stack Health
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Monitoring
    - Deploy Prod Vufind

Prod Run Functional Tests:
  stage: Deploy Prod
  extends: Run Functional Tests
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Verify Prod Stack Health
