############# Prod Deploy ###############
Set Prod Stack Name:
  stage: Deploy
  extends: Set Stack Name
  needs:
    - Verify Stack Health
  variables:
    PROD: "true"
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $PROD == "true" && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
      when: manual

Deploy Prod Compose Files:
  stage: Deploy Prod
  extends: Deploy Compose Files
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true

Perform Prod Database Backup:
  stage: Deploy Prod
  extends: Perform Database Backup
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Compose Files

Deploy Prod Internal Network:
  stage: Deploy Prod
  extends: Deploy Internal Network
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Compose Files

Initialize Prod Database Logs:
  stage: Deploy Prod
  extends: Initialize Database Logs
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Internal Network

Bootstrap Prod Stacks:
  stage: Deploy Prod
  extends: Bootstrap Stacks
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Compose Files
    - Deploy Prod Internal Network
    - Perform Prod Database Backup

Deploy Prod Solr:
  stage: Deploy Prod
  extends: Deploy Solr
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Bootstrap Prod Stacks
    - Perform Prod Database Backup

Deploy Prod DB:
  stage: Deploy Prod
  extends: Deploy DB
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Bootstrap Prod Stacks
    - Initialize Prod Database Logs
    - Perform Prod Database Backup

Deploy Prod Vufind:
  stage: Deploy Prod
  extends: Deploy Vufind
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod DB
    - Deploy Prod Solr
    - Perform Prod Database Backup

Deploy Prod Monitoring:
  stage: Deploy Prod
  extends: Deploy Monitoring
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Internal Network

Verify Prod Stack Health:
  stage: Deploy Prod
  extends: Verify Stack Health
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Monitoring
    - Deploy Prod Vufind

Prod Vufind Upgrade:
  stage: Deploy Prod
  extends: Vufind Upgrade
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_DEPLOY_FREEZE == null && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - job: Deploy Prod Vufind
      artifacts: true
    - Verify Prod Stack Health
