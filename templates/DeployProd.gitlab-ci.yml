############# Prod Deploy ###############
Set Prod Stack Name:
  stage: Deploy
  extends: Set Stack Name
  environment:
    name: $CI_COMMIT_BRANCH-prod
  needs:
    - Verify Stack Health
  variables:
    PROD: "true"
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $PROD == "true" && $CI_PIPELINE_SOURCE != "schedule"'
      when: manual

Deploy Prod Compose Files:
  stage: Deploy Prod
  environment:
    name: $CI_COMMIT_BRANCH-prod/deploy-compose
  extends: Deploy Compose Files
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true

Deploy Prod Internal Network:
  stage: Deploy Prod
  extends: Deploy Internal Network
  environment:
    name: $CI_COMMIT_BRANCH-prod/deploy-network
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Compose Files

Initialize Prod Log Dirs:
  stage: Deploy Prod
  extends: Initialize Log Dirs
  environment:
    name: $CI_COMMIT_BRANCH-prod/deploy-network
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Internal Network

Bootstrap Prod Stacks:
  stage: Deploy Prod
  environment:
    name: $CI_COMMIT_BRANCH-prod/bootstrap
  extends: Bootstrap Stacks
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Compose Files
    - Deploy Prod Internal Network

Deploy Prod ZK:
  stage: Deploy Prod
  extends: Deploy ZK
  environment:
    name: $CI_COMMIT_BRANCH-prod/deploy-zk
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Bootstrap Prod Stacks

Deploy Prod Solr:
  stage: Deploy Prod
  extends: Deploy Solr
  environment:
    name: $CI_COMMIT_BRANCH-prod/deploy-solr
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod ZK
    - Bootstrap Prod Stacks

Deploy Prod DB:
  stage: Deploy Prod
  extends: Deploy DB
  environment:
    name: $CI_COMMIT_BRANCH-prod/deploy-db
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Bootstrap Prod Stacks
    - Initialize Prod Log Dirs

Deploy Prod Vufind:
  stage: Deploy Prod
  extends: Deploy Vufind
  environment:
    name: $CI_COMMIT_BRANCH-prod/deploy-vufind
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod DB
    - Deploy Prod Solr

Deploy Prod Vufind Build Env:
  stage: Deploy Prod
  extends: Deploy Vufind Build Env
  environment:
    name: $CI_COMMIT_BRANCH-prod/deploy-buildenv
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
      when: manual
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Vufind

Deploy Prod Monitoring:
  stage: Deploy Prod
  extends: Deploy Monitoring
  environment:
    name: $CI_COMMIT_BRANCH-prod/deploy-monitoring
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Internal Network

Verify Prod Stack Health:
  stage: Deploy Prod
  extends: Verify Stack Health
  environment:
    name: $CI_COMMIT_BRANCH-prod/verify
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Deploy Prod Monitoring
    - Deploy Prod Vufind

Prod Run Functional Tests:
  stage: Deploy Prod
  extends: Run Functional Tests
  environment:
    name: $CI_COMMIT_BRANCH-prod/run-tests
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
  needs:
    - job: Set Prod Stack Name
      artifacts: true
    - Verify Prod Stack Health
